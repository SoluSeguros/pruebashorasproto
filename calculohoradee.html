<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>N√≥mina por horas (salida tipo Excel) - Jornada 7.33h</title>
<!-- CDN m√°s confiable para XLSX -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eaf0ff;
    --line:#223055; --accent:#4aa3ff; --ok:#22c55e; --warn:#f59e0b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  .card{background:rgba(17,26,46,.92);border:1px solid var(--line);border-radius:var(--radius);
        padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
  h1{margin:0 0 10px;font-size:18px}
  h2{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:600}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea{
    width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
    background:#0b1430;color:var(--text);outline:none
  }
  textarea{min-height:170px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace;font-size:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{
    border:0;border-radius:12px;padding:10px 12px;font-weight:700;
    background:var(--accent);color:#061024;cursor:pointer
  }
  button.secondary{background:#223055;color:var(--text);border:1px solid var(--line)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
        border:1px solid var(--line);background:#0b1430;color:var(--muted);font-size:12px}
  .small{font-size:12px;color:var(--muted);line-height:1.45}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse;overflow:auto}
  th,td{border-bottom:1px solid var(--line);padding:8px 8px;font-size:12px;white-space:nowrap}
  th{color:var(--muted);text-align:left;background:rgba(34,48,85,.35);position:sticky;top:0}
  .tableWrap{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px}
  .info-box {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    font-size: 12px;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" style="margin-bottom:14px">
    <h1>N√≥mina por horas ‚Äì salida tipo Excel (por concepto) - Jornada 7.33h</h1>
    <div class="small">
      Pegas tu tabla (Fecha / Entrada / Inter1 / Inter2 / Salida / Observaciones). El sistema crea filas por concepto y exporta a Excel.
      <br><span class="warn">IMPORTANTE:</span> <b>DIFERENCIAR FESTIVOS en OBSERVACIONES:</b>
      <div class="info-box">
        <span class="ok">‚úî FLC</span> = <b>Festivo Laborado Compensado</b> (0.80 adicional) ‚Üí Se da d√≠a libre<br>
        <span class="warn">‚úî FLSC</span> = <b>Festivo Laborado Sin Compensar</b> (1.80 adicional) ‚Üí No se da d√≠a libre<br>
        <span class="accent">Ejemplo:</span> "FESTIVO FLC" o "DOMINGO FLSC"
      </div>
      <span class="warn">Nocturna:</span> desde <b>9:00 p. m.</b> hasta <b>6:00 a. m.</b> (configurable).
      <br><span class="ok">Jornada legal:</span> M√°ximo <b>7.33 horas diarias</b> seg√∫n ley colombiana (44 horas semanales).
      <br><span class="ok">Festivos Colombia:</span> Sistema reconoce <b>autom√°ticamente</b> todos los festivos nacionales.
      <br><span class="ok">B√°sico siempre incluido:</b> en las 220 horas (contrato), trabaje o no.
      <br><span class="ok">Auxilio transporte:</b> por d√≠a laborado, no por horas. No excede valor diario.
      <br><span class="ok">Compensatorios:</b> distribuidos de 10am-7pm (9 franjas de 7.33h).
    </div>
  </div>

  <div class="grid">
    <!-- Entrada -->
    <div class="card">
      <h2>1) Datos y tabla</h2>

      <div class="row">
        <div>
          <label>Nombre completo</label>
          <input id="nombre" value="AROCHA CERVEN MIRIAM JOSEFINA"/>
        </div>
        <div>
          <label>Empresa</label>
          <input id="empresa" value="RESTAURANTE CAPITULO"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Puesto</label>
          <input id="puesto" value="AUXILIAR"/>
        </div>
        <div>
          <label>Salario mensual</label>
          <input id="salario" value="1423500"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Valor hora</label>
          <input id="valorHora" value="6470"/>
        </div>
        <div>
          <label>Auxilio transporte DIARIO</label>
          <input id="auxTrans" value="6667"/>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Jornada pactada (horas/d√≠a)</label>
          <input id="jornada" value="8" readonly style="background:#1a243f;color:var(--muted)"/>
          <div class="small">Solo informativo. L√≠mite legal es 7.33h</div>
        </div>
        <div>
          <label>Hora inicio nocturna</label>
          <input id="iniNoct" value="21:00"/>
        </div>
        <div>
          <label>Hora fin nocturna</label>
          <input id="finNoct" value="06:00"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Jornada legal m√°xima (horas/d√≠a)</label>
          <input id="jornadaLegal" value="7.33" readonly style="background:#0f1a33;color:var(--accent);font-weight:bold"/>
          <div class="small">Seg√∫n ley colombiana (44h semanales √∑ 6 d√≠as)</div>
        </div>
        <div>
          <label>Salario m√≠nimo mensual vigente</label>
          <input id="salarioMinimo" value="1300000"/>
          <div class="small">Para calcular derecho a auxilio</div>
        </div>
      </div>

      <label>Tabla (pegar desde Excel). Formato esperado:</label>
      <div class="pill">FECHA | ENTRADA | INTER 1 | INTER 2 | SALIDA | OBSERVACIONES</div>
      <div class="info-box">
        <b>üí° C√ìMO INDICAR FESTIVOS EN OBSERVACIONES:</b><br>
        1. <span class="ok">"FLC"</span> ‚Üí Festivo compensado (0.80 adicional) - <b>Se da d√≠a libre</b><br>
        2. <span class="warn">"FLSC"</span> ‚Üí Festivo sin compensar (1.80 adicional) - <b>No se da d√≠a libre</b><br>
        3. <span class="accent">Si no especifica, se asume FLSC (1.80)</span><br>
        <b>Ejemplos:</b> "FESTIVO FLC", "DOMINGO FLSC", "NAVIDAD FLC", "A√ëO NUEVO FLSC"
      </div>
      <textarea id="tabla" spellcheck="false">FECHA	HORA DE ENTRADA	HORA INTER 1	HORA INTER 2	HORA DE SALIDA	OBSERVACIONES
1-nov-25	01:58 PM	05:59 PM	06:59 PM	12:11 AM	
2-nov-25	01:30 PM	06:02 PM	07:00 PM	11:11 PM	
3-nov-25	01:19 PM	05:01 PM	06:19 PM	09:41 PM	
4-nov-25					COMPENSATORIO
5-nov-25					DIA DE LA FAMILIA
6-nov-25	03:00 PM	04:35 PM	06:31 PM	10:21 PM	
7-nov-25	09:57 AM	12:58 PM	04:59 PM	12:19 AM	DOMINGO FLSC
8-nov-25	02:00 PM	06:00 PM	06:59 PM	01:03 AM	
9-nov-25	01:21 PM	05:04 PM	06:18 PM	10:06 PM	
10-nov-25					COMPENSATORIO
11-nov-25	02:59 PM	04:58 PM	06:58 PM	11:03 PM	
12-nov-25	02:59 PM	04:37 PM	06:45 PM	10:55 PM	
13-nov-25	02:59 PM	04:58 PM	06:57 PM	11:24 PM	
14-nov-25	01:57 PM	05:59 PM	06:59 PM	12:03 AM	
15-nov-25	01:58 PM	06:00 PM	06:58 PM	12:30 AM	FESTIVO FLC</textarea>

      <div class="btns">
        <button id="btnCalc">Calcular</button>
        <button class="secondary" id="btnXlsx">Exportar Excel</button>
        <button class="secondary" id="btnCSV">Exportar CSV</button>
        <button class="secondary" id="btnClear">Limpiar resultado</button>
      </div>
      <div class="small" style="margin-top:10px">
        <span class="ok">‚úî</span> <b>FESTIVOS AUTOM√ÅTICOS:</b> Sistema detecta festivos nacionales colombianos.
        <br><span class="ok">‚úî</span> <b>FLC vs FLSC:</b> Usar "FLC" (0.80) o "FLSC" (1.80) en Observaciones.
        <br><span class="ok">‚úî</span> <b>SI NO ESPECIFICA:</b> Festivo detectado autom√°ticamente = <b>FLSC (1.80)</b>
        <br><span class="ok">‚úî</span> <b>B√ÅSICO SIEMPRE INCLUIDO:</b> Contrato de 220 horas mensuales.
        <br><span class="ok">‚úî</span> <b>AUXILIO TRANSPORTE:</b> Por d√≠a laborado completo.
        <br><span class="ok">‚úî</span> <b>COMPENSATORIOS:</b> Distribuidos de 10am a 7pm (9 franjas).
      </div>
    </div>

    <!-- Par√°metros -->
    <div class="card">
      <h2>2) Par√°metros de conceptos (configurables)</h2>

      <div class="small">
        Estos factores definen el pago por concepto. Se aplican al <b>valor hora</b>.
        <br>Ejemplo: Recargo nocturno = 0.35 (35% adicional).
      </div>

      <div class="row">
        <div>
          <label>Recargo nocturno ordinario (adicional)</label>
          <input id="f_noct" value="0.35"/>
        </div>
        <div>
          <label>Extra diurna ordinaria (adicional)</label>
          <input id="f_exd" value="0.25"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Extra nocturna ordinaria (adicional)</label>
          <input id="f_exn" value="0.75"/>
        </div>
        <div>
          <label>Festivo Compensado Diurno (FLC - adicional)</label>
          <input id="f_flc_d" value="0.80"/>
          <div class="small" style="color:var(--ok)">FLC: Se da d√≠a libre</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Festivo Compensado Nocturno (FLC - adicional)</label>
          <input id="f_flc_n" value="1.10"/>
          <div class="small" style="color:var(--ok)">FLC: Se da d√≠a libre</div>
        </div>
        <div>
          <label>Festivo Sin Compensar Diurno (FLSC - adicional)</label>
          <input id="f_flsc_d" value="1.80"/>
          <div class="small" style="color:var(--warn)">FLSC: No se da d√≠a libre</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Festivo Sin Compensar Nocturno (FLSC - adicional)</label>
          <input id="f_flsc_n" value="2.10"/>
          <div class="small" style="color:var(--warn)">FLSC: No se da d√≠a libre</div>
        </div>
        <div>
          <label>Extra en Festivo Diurno (adicional al recargo)</label>
          <input id="f_fest_exd" value="1.00"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Extra en Festivo Nocturno (adicional al recargo)</label>
          <input id="f_fest_exn" value="1.00"/>
        </div>
        <div>
          <label>Comisi√≥n % (sobre Total)</label>
          <input id="comision" value="0"/>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">

      <h2>3) Seguridad social y prestaciones (opcional)</h2>
      <div class="small">
        Si lo activas, calcula costos por concepto usando % t√≠picos (puedes cambiarlos).
        <br><b>Nota:</b> Para jornada incompleta, se calcula sobre salario completo.
      </div>

      <div class="row">
        <div>
          <label><input type="checkbox" id="chkSS" checked> Calcular Seguridad Social</label>
        </div>
        <div>
          <label><input type="checkbox" id="chkPrest" checked> Calcular Prestaciones</label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>EPS % (empleador)</label>
          <input id="p_eps" value="0.085"/>
        </div>
        <div>
          <label>AFP % (empleador)</label>
          <input id="p_afp" value="0.12"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ARL %</label>
          <input id="p_arl" value="0.00522"/>
        </div>
        <div>
          <label>CAJA %</label>
          <input id="p_caja" value="0.04"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Cesant√≠as %</label>
          <input id="p_ces" value="0.0833"/>
        </div>
        <div>
          <label>Primas %</label>
          <input id="p_pri" value="0.0833"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Intereses %</label>
          <input id="p_int" value="0.01"/>
        </div>
        <div>
          <label>Vacaciones %</label>
          <input id="p_vac" value="0.0417"/>
        </div>
      </div>

      <div class="small" style="margin-top:10px">
        <b>Compensatorios:</b> Distribuidos de 10am a 7pm (9 franjas de 0.814h = 7.33h total).
        <br><b>Jornada incompleta:</b> Si el empleado labora menos de 7.33h, recibe salario completo.
        <br><b>B√°sico siempre incluido:</b> El salario b√°sico corresponde a 220 horas mensuales (contrato).
      </div>
    </div>
  </div>

  <!-- Resultado -->
  <div class="card" style="margin-top:14px">
    <h2>Resultado (vista previa)</h2>
    <div class="tableWrap">
      <table id="preview">
        <thead><tr id="headRow"></tr></thead>
        <tbody id="bodyRows"></tbody>
      </table>
    </div>
    <div class="small" style="margin-top:10px">
      <b>Exporta Excel</b> para tenerlo con todas las columnas como plantilla.
      <br><b>üí° CLAVE PARA FESTIVOS:</b>
      <br><span class="ok">‚Ä¢ FLC (Festivo Laborado Compensado):</span> 0.80 adicional - <b>Se da d√≠a libre</b>
      <br><span class="warn">‚Ä¢ FLSC (Festivo Laborado Sin Compensar):</span> 1.80 adicional - <b>No se da d√≠a libre</b>
      <br><b>Compensatorios:</b> 7.33h distribuidas de 10am a 7pm (9 franjas).
      <br><b>B√°sico siempre:</b> Aparece el concepto "B√°sico" aunque trabaje solo nocturno o festivo.
      <br><b>Auxilio transporte:</b> Por d√≠a laborado, no por horas. Completo si trabaja cualquier hora.
    </div>
  </div>
</div>

<script>
// =========================
// VERIFICACI√ìN DE LIBRER√çAS
// =========================
function checkXLSXLoaded() {
  if (typeof XLSX === 'undefined') {
    console.error('XLSX no est√° cargado. Usando modo CSV.');
    return false;
  }
  return true;
}

// =========================
// Constantes de jornada legal
// =========================
const JORNADA_LEGAL_HORAS = 7.33;        // Horas m√°ximas por d√≠a seg√∫n ley
const JORNADA_LEGAL_MINUTOS = 440;      // 7.33 * 60 = 439.8 ‚âà 440 minutos

// =========================
// FESTIVOS COLOMBIA (A√ëO ESPEC√çFICO - 2025)
// =========================
function getFestivosColombia(year) {
  const festivos = [];
  
  // Festivos fijos en Colombia
  festivos.push(new Date(year, 0, 1));    // A√±o Nuevo
  festivos.push(new Date(year, 0, 6));    // D√≠a de los Reyes Magos
  festivos.push(new Date(year, 2, 19));   // D√≠a de San Jos√©
  festivos.push(new Date(year, 3, 6));    // Domingo de Ramos
  festivos.push(new Date(year, 3, 10));   // Jueves Santo
  festivos.push(new Date(year, 3, 11));   // Viernes Santo
  festivos.push(new Date(year, 4, 1));    // D√≠a del Trabajo
  festivos.push(new Date(year, 4, 12));   // D√≠a de la Ascensi√≥n
  festivos.push(new Date(year, 5, 2));    // Corpus Christi
  festivos.push(new Date(year, 5, 23));   // Sagrado Coraz√≥n
  festivos.push(new Date(year, 5, 30));   // San Pedro y San Pablo
  festivos.push(new Date(year, 6, 20));   // D√≠a de la Independencia
  festivos.push(new Date(year, 7, 7));    // Batalla de Boyac√°
  festivos.push(new Date(year, 7, 18));   // La Asunci√≥n de la Virgen
  festivos.push(new Date(year, 9, 13));   // D√≠a de la Raza
  festivos.push(new Date(year, 10, 3));   // D√≠a de Todos los Santos
  festivos.push(new Date(year, 10, 17));  // Independencia de Cartagena
  festivos.push(new Date(year, 11, 8));   // D√≠a de la Inmaculada Concepci√≥n
  festivos.push(new Date(year, 11, 25));  // Navidad
  
  // Para 2025 espec√≠ficamente, ajustar seg√∫n el calendario oficial
  if (year === 2025) {
    // Reyes Magos (primer lunes despu√©s del 6 de enero)
    festivos[1] = new Date(2025, 0, 6); // 6 de enero es lunes en 2025
    
    // Domingo de Ramos (13 de abril 2025)
    festivos[3] = new Date(2025, 3, 13);
    
    // Jueves Santo (17 de abril 2025)
    festivos[4] = new Date(2025, 3, 17);
    
    // Viernes Santo (18 de abril 2025)
    festivos[5] = new Date(2025, 3, 18);
    
    // Ascensi√≥n (26 de mayo 2025 - luna)
    festivos[6] = new Date(2025, 4, 26);
    
    // Corpus Christi (5 de junio 2025 - jueves)
    festivos[7] = new Date(2025, 5, 5);
    
    // Sagrado Coraz√≥n (26 de junio 2025 - jueves)
    festivos[8] = new Date(2025, 5, 26);
    
    // San Pedro y San Pablo (30 de junio 2025 - lunes)
    festivos[9] = new Date(2025, 5, 30);
  }
  
  return festivos;
}

// Funci√≥n para verificar si una fecha es festivo en Colombia
function esFestivoColombia(fecha) {
  const year = fecha.getFullYear();
  const festivos = getFestivosColombia(year);
  const esDomingo = fecha.getDay() === 0;
  
  // Si es domingo, siempre es festivo
  if (esDomingo) return true;
  
  // Verificar si est√° en la lista de festivos
  return festivos.some(festivo => 
    festivo.getDate() === fecha.getDate() &&
    festivo.getMonth() === fecha.getMonth() &&
    festivo.getFullYear() === fecha.getFullYear()
  );
}

// Funci√≥n para obtener el nombre del festivo
function getNombreFestivo(fecha) {
  const year = fecha.getFullYear();
  
  // Mapeo de festivos por fecha
  const festivos2025 = {
    '01-01': 'A√±o Nuevo',
    '01-06': 'D√≠a de los Reyes Magos',
    '03-19': 'D√≠a de San Jos√©',
    '04-13': 'Domingo de Ramos',
    '04-17': 'Jueves Santo',
    '04-18': 'Viernes Santo',
    '05-01': 'D√≠a del Trabajo',
    '05-26': 'D√≠a de la Ascensi√≥n',
    '06-05': 'Corpus Christi',
    '06-26': 'Sagrado Coraz√≥n',
    '06-30': 'San Pedro y San Pablo',
    '07-20': 'D√≠a de la Independencia',
    '08-07': 'Batalla de Boyac√°',
    '08-18': 'La Asunci√≥n de la Virgen',
    '10-13': 'D√≠a de la Raza',
    '11-03': 'D√≠a de Todos los Santos',
    '11-17': 'Independencia de Cartagena',
    '12-08': 'D√≠a de la Inmaculada Concepci√≥n',
    '12-25': 'Navidad'
  };
  
  const clave = `${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
  
  if (fecha.getDay() === 0 && !festivos2025[clave]) {
    return 'Domingo';
  }
  
  return festivos2025[clave] || '';
}

// =========================
// MEJORADO: Detectar tipo de festivo por observaciones (FLC vs FLSC)
// =========================
function getTipoFestivo(observacion, fecha) {
  if (!observacion) {
    // Si no hay observaci√≥n pero es festivo por calendario, asumir FLSC (1.80)
    if (fecha && esFestivoColombia(fecha)) {
      return "FESTIVO_NO_COMPENSADO"; // FLSC por defecto
    }
    return null;
  }
  
  const obs = observacion.trim().toUpperCase();
  
  // PRIORIDAD 1: Buscar espec√≠ficamente FLC o FLSC
  if (obs.includes("FLC")) {
    return "FESTIVO_COMPENSADO";
  }
  
  if (obs.includes("FLSC")) {
    return "FESTIVO_NO_COMPENSADO";
  }
  
  // PRIORIDAD 2: Si dice festivo pero no especifica
  if (obs.includes("FESTIVO") || obs.includes("DOMINGO") || obs.includes("DOMINICAL")) {
    // Por defecto: Festivo detectado autom√°ticamente = FLSC (1.80)
    return "FESTIVO_NO_COMPENSADO";
  }
  
  // Si no es festivo por observaci√≥n pero s√≠ por calendario
  if (fecha && esFestivoColombia(fecha)) {
    return "FESTIVO_NO_COMPENSADO"; // FLSC por defecto
  }
  
  return null;
}

// =========================
// Utilidades de tiempo
// =========================
function parseDateFlexible(s){
  if(!s) return null;
  s = String(s).trim();
  const m = s.match(/^(\d{1,2})-([a-zA-Z√±√ë]{3})-(\d{2}|\d{4})$/);
  if(m){
    const dd = parseInt(m[1],10);
    const mon = m[2].toLowerCase();
    const yy = m[3].length===2 ? (2000+parseInt(m[3],10)) : parseInt(m[3],10);
    const map = {ene:0,feb:1,mar:2,abr:3,may:4,jun:5,jul:6,ago:7,sep:8,oct:9,nov:10,dic:11};
    if(map[mon]===undefined) return null;
    return new Date(yy, map[mon], dd);
  }
  const m2 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m2){
    return new Date(parseInt(m2[3],10), parseInt(m2[2],10)-1, parseInt(m2[1],10));
  }
  const m3 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m3){
    return new Date(parseInt(m3[1],10), parseInt(m3[2],10)-1, parseInt(m3[3],10));
  }
  return null;
}

function parseTime12or24(s){
  if(!s) return null;
  s = String(s).trim();
  if(!s) return null;
  let m = s.match(/^(\d{1,2}):(\d{2})\s*([AP]M)$/i);
  if(m){
    let hh = parseInt(m[1],10);
    const mm = parseInt(m[2],10);
    const ap = m[3].toUpperCase();
    if(hh===12) hh=0;
    if(ap==='PM') hh += 12;
    return {h:hh, m:mm};
  }
  m = s.match(/^(\d{1,2}):(\d{2})$/);
  if(m){
    return {h:parseInt(m[1],10), m:parseInt(m[2],10)};
  }
  return null;
}

function toDateTime(d, t){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.h, t.m, 0, 0);
}

function minutesBetween(a,b){
  return Math.max(0, Math.round((b - a) / 60000));
}

function dayNameES(d){
  const arr = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
  const nombre = arr[d.getDay()];
  const esFestivo = esFestivoColombia(d);
  const nombreFestivo = getNombreFestivo(d);
  
  if (esFestivo) {
    if (nombreFestivo) {
      return nombre + " üéâ (" + nombreFestivo + ")";
    } else {
      return nombre + " üéâ";
    }
  }
  return nombre;
}

function fmtCOP(n){
  return (Math.round(n)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function hhmmToMin(s){
  const [h,m]=s.split(":").map(x=>parseInt(x,10));
  return h*60+m;
}

// =========================
// Franjas 7-25 (7am a 1am)
// =========================
const SLOT_START = 7;
const SLOT_END   = 25;
function slotLabels(){
  const labels=[];
  for(let h=SLOT_START; h<SLOT_END; h++){
    labels.push(`${h}-${h+1}`);
  }
  return labels;
}

function slotIndexForMinute(minFromDayStart){
  const base = SLOT_START*60;
  const idx = Math.floor((minFromDayStart - base)/60);
  if(idx<0 || idx>= (SLOT_END-SLOT_START)) return -1;
  return idx;
}

// =========================
// Clasificaci√≥n diurna/nocturna
// =========================
function isNocturna(minFromMid, iniNoctMin, finNoctMin){
  const mod = ((minFromMid%1440)+1440)%1440;
  if(iniNoctMin < finNoctMin){
    return (mod>=iniNoctMin && mod<finNoctMin);
  }
  return (mod>=iniNoctMin || mod<finNoctMin);
}

// =========================
// L√ìGICA DE OBSERVACIONES - REGLAS ESPEC√çFICAS
// =========================
function getObservationRules(observacion) {
  const obs = (observacion || "").trim().toUpperCase();
  
  if (obs.includes("COMPENSATORIO")) {
    return {
      tipo: "COMPENSATORIO",
      pagoBasico: true,
      pagoAuxilio: true,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: JORNADA_LEGAL_HORAS,
      calcularTodo: true,
      horarioEspecial: true,
      inicioLaboral: 10,
      finLaboral: 19
    };
  }
  
  if (obs.includes("EMPLEADO DEL MES")) {
    return {
      tipo: "EMPLEADO_MES",
      pagoBasico: true,
      pagoAuxilio: true,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: JORNADA_LEGAL_HORAS,
      calcularTodo: true,
      horarioEspecial: true,
      inicioLaboral: 10,
      finLaboral: 19
    };
  }
  
  if (obs.includes("INCAPACIDAD")) {
    return {
      tipo: "INCAPACIDAD",
      pagoBasico: true,
      pagoAuxilio: false,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: JORNADA_LEGAL_HORAS,
      calcularTodo: true,
      horarioEspecial: false
    };
  }
  
  if (obs.includes("DIA DE LA FAMILIA") || obs.includes("FESTIVO NO LABORADO")) {
    return {
      tipo: "DIA_FESTIVO_NO_LABORADO",
      pagoBasico: true,
      pagoAuxilio: false,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: JORNADA_LEGAL_HORAS,
      calcularTodo: true,
      horarioEspecial: true,
      inicioLaboral: 10,
      finLaboral: 19
    };
  }
  
  if (obs.includes("FALTA INJUSTIFICADA")) {
    return {
      tipo: "FALTA_INJUSTIFICADA",
      pagoBasico: false,
      pagoAuxilio: false,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: 0,
      calcularTodo: false
    };
  }
  
  if (obs.includes("LICENCIA NO REMUNERADA")) {
    return {
      tipo: "LICENCIA_NO_REMUNERADA",
      pagoBasico: false,
      pagoAuxilio: false,
      pagoExtras: false,
      pagoRecargos: false,
      horasNormales: 0,
      calcularTodo: false
    };
  }
  
  // Si no hay observaci√≥n o no coincide con ninguna regla especial
  return {
    tipo: "NORMAL",
    pagoBasico: true,
    pagoAuxilio: true,
    pagoExtras: true,
    pagoRecargos: true,
    horasNormales: null,
    calcularTodo: true,
    horarioEspecial: false
  };
}

// =========================
// NUEVO: Obtener etiqueta descriptiva para tipo de festivo
// =========================
function getEtiquetaFestivo(tipoFestivo) {
  switch(tipoFestivo) {
    case "FESTIVO_COMPENSADO":
      return "FLC (Compensado - 0.80)";
    case "FESTIVO_NO_COMPENSADO":
      return "FLSC (Sin Compensar - 1.80)";
    default:
      return "";
  }
}

// =========================
// Calcular pago b√°sico considerando jornada incompleta
// =========================
function calcularPagoBasico(horasTrabajadas, valorHora, salarioDiario) {
  const horasLegales = JORNADA_LEGAL_HORAS;
  
  if (horasTrabajadas < horasLegales && horasTrabajadas > 0) {
    const valorHoraEfectivo = salarioDiario / horasTrabajadas;
    
    return {
      pagoTotal: salarioDiario,
      valorHoraEfectivo: valorHoraEfectivo,
      horasFacturadas: horasTrabajadas,
      esJornadaIncompleta: true,
      mensaje: `Jornada incompleta (${horasTrabajadas.toFixed(2)}h < ${horasLegales}h): Salario completo`
    };
  } else {
    const pago = horasTrabajadas * valorHora;
    return {
      pagoTotal: pago,
      valorHoraEfectivo: valorHora,
      horasFacturadas: horasTrabajadas,
      esJornadaIncompleta: false,
      mensaje: `Jornada normal (${horasTrabajadas.toFixed(2)}h)`
    };
  }
}

// =========================
// Distribuir horas en franjas espec√≠ficas (10am-7pm)
// =========================
function distribuirHorasEnFranjasLaborales(nSlots, totalHoras, inicioLaboral = 10, finLaboral = 19) {
  const slots = Array(nSlots).fill(0);
  
  const franjasLaborales = [];
  for (let i = 0; i < nSlots; i++) {
    const horaFranja = SLOT_START + i;
    franjasLaborales[i] = (horaFranja >= inicioLaboral && horaFranja < finLaboral);
  }
  
  const totalFranjasLaborales = franjasLaborales.filter(B => B).length;
  
  if (totalFranjasLaborales === 0) {
    const horasPorFranja = totalHoras / nSlots;
    for (let i = 0; i < nSlots; i++) {
      slots[i] = horasPorFranja;
    }
  } else {
    const horasPorFranjaLaboral = totalHoras / totalFranjasLaborales;
    for (let i = 0; i < nSlots; i++) {
      slots[i] = franjasLaborales[i] ? horasPorFranjaLaboral : 0;
    }
  }
  
  return slots;
}

// =========================
// Distribuir horas b√°sicas (SIEMPRE 7.33h para el b√°sico)
// =========================
function distribuirHorasBasicas(horasDiurnasTrabajadas, esJornadaIncompleta, totalHorasTrabajadas = 0) {
  const nSlots = SLOT_END - SLOT_START;
  const slots = Array(nSlots).fill(0);
  
  const horasBasicas = JORNADA_LEGAL_HORAS;
  
  if (horasDiurnasTrabajadas > 0) {
    const inicioLaboral = 9;
    const finLaboral = 17;
    
    const horasPorFranjaLaboral = horasBasicas / (finLaboral - inicioLaboral);
    
    for (let i = 0; i < nSlots; i++) {
      const horaFranja = SLOT_START + i;
      if (horaFranja >= inicioLaboral && horaFranja < finLaboral) {
        slots[i] = horasPorFranjaLaboral;
      }
    }
  } else {
    const inicioLaboral = 9;
    const finLaboral = 17;
    
    const horasPorFranjaLaboral = horasBasicas / (finLaboral - inicioLaboral);
    
    for (let i = 0; i < nSlots; i++) {
      const horaFranja = SLOT_START + i;
      if (horaFranja >= inicioLaboral && horaFranja < finLaboral) {
        slots[i] = horasPorFranjaLaboral;
      }
    }
  }
  
  return slots;
}

// =========================
// Calcular derecho a auxilio de transporte
// =========================
function calcularDerechoAuxilio(salarioMensual, salarioMinimoMensual) {
  return salarioMensual <= (salarioMinimoMensual * 2);
}

// =========================
// Calcular auxilio de transporte CORRECTO
// =========================
function calcularAuxilioTransporte(salarioMensual, salarioMinimoMensual, auxilioMensual, horasTrabajadas, esFestivo = false, rules = null) {
  const tieneDerecho = calcularDerechoAuxilio(salarioMensual, salarioMinimoMensual);
  if (!tieneDerecho) {
    return {
      valor: 0,
      mensaje: "No tiene derecho a auxilio (salario > 2 SMLMV)",
      auxilioCompleto: false
    };
  }
  
  const trabajoAlgunaHora = horasTrabajadas > 0;
  
  if (rules) {
    if (rules.pagoAuxilio && trabajoAlgunaHora) {
      const auxilioDiario = auxilioMensual / 30;
      const salarioDiario = salarioMensual / 30;
      const auxilioFinal = Math.min(auxilioDiario, salarioDiario);
      
      return {
        valor: auxilioFinal,
        mensaje: "Auxilio completo (d√≠a laborado)",
        auxilioCompleto: true
      };
    }
    return {
      valor: 0,
      mensaje: "No corresponde auxilio seg√∫n reglas",
      auxilioCompleto: false
    };
  }
  
  if (trabajoAlgunaHora) {
    const auxilioDiario = auxilioMensual / 30;
    const salarioDiario = salarioMensual / 30;
    const auxilioFinal = Math.min(auxilioDiario, salarioDiario);
    
    return {
      valor: auxilioFinal,
      mensaje: "Auxilio completo (d√≠a laborado)",
      auxilioCompleto: true
    };
  }
  
  return {
    valor: 0,
    mensaje: "No trabaj√≥, no hay auxilio",
    auxilioCompleto: false
  };
}

// =========================
// C√°lculo por d√≠a -> filas por concepto
// =========================
function calcDayRows({nombre,empresa,puesto,salario,valorHora,auxTrans,jornada,iniNoct,finNoct,factors,ss,prest,comisionPct,salarioMinimo}, day){
  const d = day.date;
  const dia = dayNameES(d);
  const observacion = day.observacion || "";
  const rules = getObservationRules(observacion);
  
  // MEJORADO: Obtener tipo de festivo considerando fecha y observaci√≥n
  const tipoFestivoObservacion = getTipoFestivo(observacion, d);
  
  // Determinar si es festivo (por calendario O por observaci√≥n)
  const esFestivoPorCalendario = esFestivoColombia(d);
  const esFestivoPorObservacion = tipoFestivoObservacion !== null;
  const esFestivo = esFestivoPorCalendario || esFestivoPorObservacion;
  
  // Determinar tipo de festivo
  let tipoFestivo = null;
  if (esFestivo) {
    if (tipoFestivoObservacion) {
      tipoFestivo = tipoFestivoObservacion; // Prioridad a observaci√≥n
    } else if (esFestivoPorCalendario) {
      // Festivo detectado autom√°ticamente = FLSC (1.80)
      tipoFestivo = "FESTIVO_NO_COMPENSADO";
    }
  }
  
  // NUEVO: Verificar si es d√≠a NO laborado por ser festivo
  const tIn = parseTime12or24(day.entry);
  const tOut = parseTime12or24(day.exit);
  const tieneHorarioLaborado = tIn && tOut;
  
  // Si es festivo pero NO tiene horario laborado, tratarlo como d√≠a festivo no laborado
  if (esFestivo && !tieneHorarioLaborado && !observacion.includes("FLC") && !observacion.includes("FLSC")) {
    // D√≠a festivo no laborado: b√°sico completo, sin auxilio, distribuido 10am-7pm
    return procesarDiaFestivoNoLaborado({
      nombre, empresa, puesto, salario, valorHora, auxTrans,
      d, dia, observacion, rules, comisionPct, ss, prest,
      salarioMinimo, tipoFestivo, esFestivo
    });
  }
  
  // Si no se debe calcular nada (FALTA INJUSTIFICADA, LICENCIA NO REMUNERADA)
  if (!rules.calcularTodo) {
    return [];
  }
  
  const intervals = [];
  let totalHoras = 0;
  let horasDiurnasTrabajadas = 0;
  let horasNocturnasTrabajadas = 0;
  
  // ============================================
  // 1. D√çAS CON REGLAS ESPECIALES (Compensatorio, Empleado del Mes, etc.)
  // ============================================
  if (rules.horasNormales !== null) {
    return procesarDiaEspecial({
      nombre, empresa, puesto, salario, valorHora, auxTrans,
      d, dia, observacion, rules, comisionPct, ss, prest,
      salarioMinimo, esFestivo, tipoFestivo
    });
  }
  
  // ============================================
  // 2. D√çAS NORMALES (con horario real)
  // ============================================
  const tI1 = parseTime12or24(day.inter1);
  const tI2 = parseTime12or24(day.inter2);

  if(!tIn || !tOut) {
    if (observacion && (observacion.includes("VACACIONES") || observacion.includes("LICENCIA"))) {
      totalHoras = 0;
    } else {
      return [];
    }
  } else {
    if(tI1 && tI2){
      const a1 = toDateTime(d, tIn);
      const b1 = toDateTime(d, tI1);
      const a2 = toDateTime(d, tI2);
      let b2 = toDateTime(d, tOut);
      if(b2 < a2) b2 = new Date(b2.getTime() + 24*60*60000);
      let bb1=b1; if(bb1<a1) bb1 = new Date(bb1.getTime()+24*60*60000);
      intervals.push([a1, bb1]);
      intervals.push([a2, b2]);
    } else {
      const a = toDateTime(d, tIn);
      let b = toDateTime(d, tOut);
      if(b < a) b = new Date(b.getTime() + 24*60*60000);
      intervals.push([a,b]);
    }

    let totalMin = 0;
    for(const [a,b] of intervals) totalMin += minutesBetween(a,b);
    totalHoras = totalMin/60;
  }
  
  const salarioDiario = valorHora * JORNADA_LEGAL_HORAS;
  const pagoBasicoInfo = calcularPagoBasico(totalHoras, valorHora, salarioDiario);
  
  const iniNoctMin = hhmmToMin(iniNoct);
  const finNoctMin = hhmmToMin(finNoct);
  const labels = slotLabels();
  const nSlots = labels.length;

  let workedMinutes = [];
  if (totalHoras > 0) {
    for(const [a,b] of intervals){
      let t = new Date(a);
      while(t < b){
        workedMinutes.push(new Date(t));
        t.setMinutes(t.getMinutes()+1);
      }
    }
    workedMinutes.sort((x,y)=>x-y);
  }

  const ordLimitMin = JORNADA_LEGAL_MINUTOS;
  const ordMinutes = workedMinutes.slice(0, Math.min(ordLimitMin, workedMinutes.length));
  const extraMinutes = workedMinutes.slice(ordLimitMin);

  function addMinuteToSlots(arr, dt){
    const baseDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    let minFromMid = (dt - baseDay)/60000;
    if(minFromMid<0) minFromMid += 1440;
    if(dt.getDate()!==d.getDate() || dt.getMonth()!==d.getMonth() || dt.getFullYear()!==d.getFullYear()){
      minFromMid += 1440;
    }
    const idx = slotIndexForMinute(minFromMid);
    if(idx>=0) arr[idx] += 1/60;
  }

  const basicSlots = distribuirHorasBasicas(0, pagoBasicoInfo.esJornadaIncompleta, totalHoras);
  
  const noctRecSlots = Array(nSlots).fill(0);
  const exdSlots = Array(nSlots).fill(0);
  const exnSlots = Array(nSlots).fill(0);
  
  const flcDiurnoSlots = Array(nSlots).fill(0);
  const flcNoctSlots = Array(nSlots).fill(0);
  const flscDiurnoSlots = Array(nSlots).fill(0);
  const flscNoctSlots = Array(nSlots).fill(0);
  const festExdSlots = Array(nSlots).fill(0);
  const festExnSlots = Array(nSlots).fill(0);
  
  const auxSlots = Array(nSlots).fill(0);

  function isNoctDT(dt){
    const baseDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    let minFromMid = (dt - baseDay)/60000;
    if(dt.getDate()!==d.getDate() || dt.getMonth()!==d.getMonth() || dt.getFullYear()!==d.getFullYear()){
      minFromMid += 1440;
    }
    return isNocturna(minFromMid, iniNoctMin, finNoctMin);
  }

  if (totalHoras > 0) {
    for(const dt of ordMinutes){
      const noct = isNoctDT(dt);
      
      if(esFestivo){
        const esNoCompensado = tipoFestivo === "FESTIVO_NO_COMPENSADO";
        
        if(noct){
          if(esNoCompensado){
            addMinuteToSlots(flscNoctSlots, dt);
          } else {
            addMinuteToSlots(flcNoctSlots, dt);
          }
        } else {
          if(esNoCompensado){
            addMinuteToSlots(flscDiurnoSlots, dt);
          } else {
            addMinuteToSlots(flcDiurnoSlots, dt);
          }
        }
      } else {
        if(noct){
          addMinuteToSlots(noctRecSlots, dt);
          horasNocturnasTrabajadas += 1/60;
        } else {
          horasDiurnasTrabajadas += 1/60;
        }
      }
    }
    
    for(const dt of extraMinutes){
      const noct = isNoctDT(dt);
      
      if(esFestivo){
        if(noct){
          addMinuteToSlots(festExnSlots, dt);
        } else {
          addMinuteToSlots(festExdSlots, dt);
        }
      } else {
        if(noct){
          addMinuteToSlots(exnSlots, dt);
        } else {
          addMinuteToSlots(exdSlots, dt);
        }
      }
    }
  }

  const auxilioInfo = calcularAuxilioTransporte(
    parseFloat(salario || 0),
    parseFloat(salarioMinimo || 0),
    auxTrans * 30,
    totalHoras,
    esFestivo,
    rules
  );

  if (auxilioInfo.valor > 0 && totalHoras > 0) {
    const totalHorasTrabajadasEnFranjas = workedMinutes.length / 60;
    for(const dt of workedMinutes){
      addMinuteToSlots(auxSlots, dt);
    }
    const factorAjuste = 1 / (totalHorasTrabajadasEnFranjas > 0 ? totalHorasTrabajadasEnFranjas : 1);
    for(let i = 0; i < auxSlots.length; i++) {
      auxSlots[i] = auxSlots[i] * factorAjuste;
    }
  }

  // Funci√≥n auxiliar para construir filas especiales
  function buildRowSpecial(params){
    const {nombre, empresa, puesto, salario, valorHora, auxTrans, d, dia, observacion, rules, 
           comisionPct, ss, prest, concepto, slotHours, incluirAuxilio, esBasico, esFestivo, 
           pagoBasicoCalculado, auxilioInfo, horarioEspecial, tipoFestivoEspecial} = params;
    
    const vh = parseFloat(valorHora||0);
    const labels = slotLabels();
    const totalHorasConcepto = slotHours.reduce((a,b)=>a+b,0);
    let totalPorConcepto = 0;
    const vlrSlots = [];

    if (incluirAuxilio) {
      for (let i = 0; i < slotHours.length; i++) {
        const horasInSlot = slotHours[i];
        if (totalHorasConcepto === 0) {
          vlrSlots.push(0);
        } else {
          vlrSlots.push((horasInSlot / totalHorasConcepto) * auxTrans);
        }
      }
      totalPorConcepto = vlrSlots.reduce((a,b)=>a+b,0);
    } else if (esBasico) {
      for (let i = 0; i < slotHours.length; i++) {
        vlrSlots.push((slotHours[i] / totalHorasConcepto) * pagoBasicoCalculado.pagoTotal);
      }
      totalPorConcepto = vlrSlots.reduce((a,b)=>a+b,0);
    }

    const row = {};
    row["Nombre completo"] = nombre;
    row["Empresa"] = empresa;
    row["Puesto"] = puesto;
    row["Salario mensual"] = salario ? salario : "";
    row["Valor Hora"] = vh;
    row["Fecha"] = formatDateES(d);
    row["D√≠a"] = dia;
    row["Es Festivo"] = esFestivo ? "S√≠ üéâ" : "No";
    // MEJORADO: Mostrar tipo de festivo claramente
    if (tipoFestivoEspecial) {
      row["Tipo Festivo"] = getEtiquetaFestivo(tipoFestivoEspecial);
    } else if (esFestivo) {
      row["Tipo Festivo"] = "FLSC (Sin especificar)";
    }
    row["Concepto"] = concepto;
    row["Observaci√≥n"] = observacion;
    row["Tipo Observaci√≥n"] = rules.tipo;
    row["Jornada Legal"] = JORNADA_LEGAL_HORAS + " horas";
    row["Jornada Incompleta"] = pagoBasicoCalculado.esJornadaIncompleta ? "S√≠" : "No";
    if (horarioEspecial) {
      row["Horario Distribuci√≥n"] = horarioEspecial;
    }

    labels.forEach((lab,i) => row[lab] = round3(slotHours[i] || 0));
    row["Total Horas"] = round3(totalHorasConcepto);

    labels.forEach((lab,i) => row["vlr "+lab.replace("-","-")] = fmtMoney(vlrSlots[i] || 0));
    row["Total por concepto"] = fmtMoney(totalPorConcepto);

    const ibc = esBasico ? totalPorConcepto : 0;
    
    const calcSS = ss.enabled && esBasico ? {
      valor_diario: 0,
      eps: ibc * ss.eps,
      afp: ibc * ss.afp,
      arl: ibc * ss.arl,
      caja: ibc * ss.caja
    } : {valor_diario:0, eps:0, afp:0, arl:0, caja:0};

    const totalSS = (calcSS.eps + calcSS.afp + calcSS.arl + calcSS.caja);

    const calcPrest = prest.enabled && esBasico ? {
      ces: ibc * prest.ces,
      pri: ibc * prest.pri,
      inte: ibc * prest.inte,
      vac: ibc * prest.vac
    } : {ces:0, pri:0, inte:0, vac:0};

    const totalPrest = (calcPrest.ces + calcPrest.pri + calcPrest.inte + calcPrest.vac);

    const total = totalPorConcepto + totalSS + totalPrest;
    const valCom = total * comisionPct;
    const valTotal = total + valCom;

    row["Valor diario de seguridad social"] = fmtMoney(calcSS.valor_diario || 0);
    row["EPS"] = fmtMoney(calcSS.eps || 0);
    row["AFP"] = fmtMoney(calcSS.afp || 0);
    row["ARL"] = fmtMoney(calcSS.arl || 0);
    row["CAJA"] = fmtMoney(calcSS.caja || 0);
    row["Total Seguridad Social"] = fmtMoney(totalSS);

    row["CESANTIAS"] = fmtMoney(calcPrest.ces || 0);
    row["PRIMAS"] = fmtMoney(calcPrest.pri || 0);
    row["INTERES"] = fmtMoney(calcPrest.inte || 0);
    row["VACACIONES"] = fmtMoney(calcPrest.vac || 0);
    row["Total Prestaciones Sociales"] = fmtMoney(totalPrest);

    row["Total"] = fmtMoney(total);
    row["Valor Comisi√≥n"] = fmtMoney(valCom);
    row["Valor Total"] = fmtMoney(valTotal);
    
    let observacionMsg = pagoBasicoCalculado.mensaje;
    if (horarioEspecial === "10am-7pm") {
      observacionMsg += " | Distribuido en horario 10am-7pm (9 franjas)";
    }
    if (tipoFestivoEspecial) {
      const etiqueta = getEtiquetaFestivo(tipoFestivoEspecial);
      observacionMsg += " | " + etiqueta;
    }
    if (auxilioInfo) {
      observacionMsg += " | " + auxilioInfo.mensaje;
    }
    row["Observaciones"] = observacionMsg;

    return row;
  }

  // Funci√≥n para construir filas para d√≠as normales/festivos
  function buildRow(concepto, slotHours, factorAdicional, esFestivoConcepto = false, tipoFestivoConcepto = null, esBasico = false){
    const vh = parseFloat(valorHora||0);
    const totalHorasConcepto = slotHours.reduce((a,b)=>a+b,0);
    
    if(totalHorasConcepto <= 0 && !esBasico) return null;
    
    let totalPorConcepto = 0;
    const vlrSlots = [];

    if(concepto === "Auxilio de Transporte"){
      const vlrSlotsCalc = slotHours.map(hoursInSlot => {
        if(totalHorasConcepto === 0) return 0;
        return (hoursInSlot / totalHorasConcepto) * auxilioInfo.valor;
      });
      totalPorConcepto = vlrSlotsCalc.reduce((a,b)=>a+b,0);
      
      const row = {};
      row["Nombre completo"]=nombre;
      row["Empresa"]=empresa;
      row["Puesto"]=puesto;
      row["Salario mensual"]=salario? salario : "";
      row["Valor Hora"]=vh;
      row["Fecha"]=formatDateES(d);
      row["D√≠a"]=dia;
      row["Es Festivo"] = esFestivo ? "S√≠ üéâ" : "No";
      // MEJORADO: Mostrar tipo de festivo
      if (tipoFestivo) {
        row["Tipo Festivo"] = getEtiquetaFestivo(tipoFestivo);
      } else if (esFestivo) {
        row["Tipo Festivo"] = "FLSC (Sin especificar)";
      }
      row["Concepto"]=concepto;
      row["Observaci√≥n"]=observacion;
      row["Tipo Observaci√≥n"]=rules.tipo;
      row["Jornada Legal"] = JORNADA_LEGAL_HORAS + " horas";
      row["Jornada Incompleta"] = pagoBasicoInfo.esJornadaIncompleta ? "S√≠" : "No";

      labels.forEach((lab,i)=> row[lab]=round3(slotHours[i]||0));
      row["Total Horas"]=round3(totalHorasConcepto);

      labels.forEach((lab,i)=> row["vlr "+lab.replace("-","-")]=fmtMoney(vlrSlotsCalc[i]||0));
      row["Total por concepto"]=fmtMoney(totalPorConcepto);

      row["Valor diario de seguridad social"]=0;
      row["EPS"]=0;
      row["AFP"]=0;
      row["ARL"]=0;
      row["CAJA"]=0;
      row["Total Seguridad Social"]=0;

      row["CESANTIAS"]=0;
      row["PRIMAS"]=0;
      row["INTERES"]=0;
      row["VACACIONES"]=0;
      row["Total Prestaciones Sociales"]=0;

      row["Total"]=fmtMoney(totalPorConcepto);
      row["Valor Comisi√≥n"]=fmtMoney(totalPorConcepto * comisionPct);
      row["Valor Total"]=fmtMoney(totalPorConcepto + (totalPorConcepto * comisionPct));
      
      let obsText = auxilioInfo.mensaje;
      if (esFestivoConcepto) {
        obsText += " | Festivo";
        if (tipoFestivoConcepto === "FESTIVO_NO_COMPENSADO") {
          obsText += " (FLSC - Sin compensar)";
        } else if (tipoFestivoConcepto === "FESTIVO_COMPENSADO") {
          obsText += " (FLC - Compensado)";
        }
      }
      row["Observaciones"] = obsText;

      return row;
    }

    if (esBasico) {
      const valorHoraUsar = pagoBasicoInfo.esJornadaIncompleta ? 
        pagoBasicoInfo.valorHoraEfectivo : vh;
      
      const vlrSlotsCalc = slotHours.map(h=>{
        if(h<=0) return 0;
        return h * valorHoraUsar * factorAdicional;
      });
      totalPorConcepto = vlrSlotsCalc.reduce((a,b)=>a+b,0);
    } else {
      const vlrSlotsCalc = slotHours.map(h=>{
        if(h<=0) return 0;
        return h * vh * factorAdicional;
      });
      totalPorConcepto = vlrSlotsCalc.reduce((a,b)=>a+b,0);
    }

    const aplicaIBC = esBasico;
    const ibc = aplicaIBC ? totalPorConcepto : 0;

    const calcSS = ss.enabled && aplicaIBC ? {
      valor_diario: 0,
      eps: ibc * ss.eps,
      afp: ibc * ss.afp,
      arl: ibc * ss.arl,
      caja: ibc * ss.caja
    } : {valor_diario:0,eps:0,afp:0,arl:0,caja:0};

    const totalSS = (calcSS.eps+calcSS.afp+calcSS.arl+calcSS.caja);

    const calcPrest = prest.enabled && aplicaIBC ? {
      ces: ibc * prest.ces,
      pri: ibc * prest.pri,
      inte: ibc * prest.inte,
      vac: ibc * prest.vac
    } : {ces:0,pri:0,inte:0,vac:0};

    const totalPrest = (calcPrest.ces+calcPrest.pri+calcPrest.inte+calcPrest.vac);

    const total = totalPorConcepto + totalSS + totalPrest;
    const valCom = total * comisionPct;
    const valTotal = total + valCom;

    const row = {};
    row["Nombre completo"]=nombre;
    row["Empresa"]=empresa;
    row["Puesto"]=puesto;
    row["Salario mensual"]=salario? salario : "";
    row["Valor Hora"]=vh;
    row["Fecha"]=formatDateES(d);
    row["D√≠a"]=dia;
    row["Es Festivo"] = esFestivo ? "S√≠ üéâ" : "No";
    // MEJORADO: Mostrar tipo de festivo
    if (tipoFestivo) {
      row["Tipo Festivo"] = getEtiquetaFestivo(tipoFestivo);
    } else if (esFestivo) {
      row["Tipo Festivo"] = "FLSC (Sin especificar)";
    }
    row["Concepto"]=concepto;
    row["Observaci√≥n"]=observacion;
    row["Tipo Observaci√≥n"]=rules.tipo;
    row["Jornada Legal"] = JORNADA_LEGAL_HORAS + " horas";
    row["Jornada Incompleta"] = pagoBasicoInfo.esJornadaIncompleta ? "S√≠" : "No";

    labels.forEach((lab,i)=> row[lab]=round3(slotHours[i]||0));
    row["Total Horas"]=round3(totalHorasConcepto);

    labels.forEach((lab,i)=> {
      if (esBasico && pagoBasicoInfo.esJornadaIncompleta) {
        row["vlr "+lab.replace("-","-")] = fmtMoney(slotHours[i] * pagoBasicoInfo.valorHoraEfectivo || 0);
      } else {
        row["vlr "+lab.replace("-","-")] = fmtMoney(slotHours[i] * vh * factorAdicional || 0);
      }
    });
    row["Total por concepto"]=fmtMoney(totalPorConcepto);

    row["Valor diario de seguridad social"]=fmtMoney(calcSS.valor_diario||0);
    row["EPS"]=fmtMoney(calcSS.eps||0);
    row["AFP"]=fmtMoney(calcSS.afp||0);
    row["ARL"]=fmtMoney(calcSS.arl||0);
    row["CAJA"]=fmtMoney(calcSS.caja||0);
    row["Total Seguridad Social"]=fmtMoney(totalSS);

    row["CESANTIAS"]=fmtMoney(calcPrest.ces||0);
    row["PRIMAS"]=fmtMoney(calcPrest.pri||0);
    row["INTERES"]=fmtMoney(calcPrest.inte||0);
    row["VACACIONES"]=fmtMoney(calcPrest.vac||0);
    row["Total Prestaciones Sociales"]=fmtMoney(totalPrest);

    row["Total"]=fmtMoney(total);
    row["Valor Comisi√≥n"]=fmtMoney(valCom);
    row["Valor Total"]=fmtMoney(valTotal);
    
    let obsText = "";
    if (esBasico && pagoBasicoInfo.esJornadaIncompleta) {
      obsText = "Jornada incompleta: salario completo (valor hora efectivo: " + 
               fmtCOP(pagoBasicoInfo.valorHoraEfectivo) + ")";
    } else if (esBasico) {
      obsText = "B√°sico por contrato (220 horas mensuales)";
    }
    
    if (esFestivoConcepto && !esBasico) {
      const nombreFestivo = getNombreFestivo(d);
      obsText += (obsText ? " | " : "") + "Recargo festivo";
      if (nombreFestivo) obsText += ": " + nombreFestivo;
      if (tipoFestivoConcepto === "FESTIVO_NO_COMPENSADO") {
        obsText += " (FLSC - Sin compensar, 1.80 adicional)";
      } else if (tipoFestivoConcepto === "FESTIVO_COMPENSADO") {
        obsText += " (FLC - Compensado, 0.80 adicional)";
      }
    }
    
    if (!obsText) obsText = "Concepto ordinario";
    row["Observaciones"] = obsText;

    return row;
  }

  // Si hay observaci√≥n pero no es una regla especial que ya procesamos
  if (observacion && rules.tipo !== "NORMAL") {
    return [];
  }

  // Construir todas las filas necesarias
  const rows = [];
  
  // ============================================
  // 3. SIEMPRE AGREGAR B√ÅSICO (CONTRATO 220 HORAS)
  // ============================================
  if(rules.pagoBasico) {
    if(!esFestivo) {
      rows.push(buildRow("B√°sico Ordinario", basicSlots, 1.0, false, null, true));
    } else {
      rows.push(buildRow("B√°sico Ordinario", basicSlots, 1.0, true, tipoFestivo, true));
    }
  }
  
  if(!esFestivo){
    // D√çA ORDINARIO (no festivo)
    if(sumArr(noctRecSlots)>0) {
      const factorNocturno = factors.noct;
      rows.push(buildRow("Recargo Nocturno Ordinario", noctRecSlots, factorNocturno, false));
    }
    
    if(sumArr(exdSlots)>0) {
      const factorExd = factors.exd;
      rows.push(buildRow("Hora Extra Diurna Ordinaria", exdSlots, factorExd, false));
    }
    
    if(sumArr(exnSlots)>0) {
      const factorExn = factors.exn;
      rows.push(buildRow("Hora Extra Nocturna Ordinaria", exnSlots, factorExn, false));
    }
    
  } else {
    // D√çA FESTIVO (domingo o festivo nacional)
    const esNoCompensado = tipoFestivo === "FESTIVO_NO_COMPENSADO";
    
    // Recargo Festivo Compensado Diurno (FLC) - 0.80 adicional
    if(!esNoCompensado && sumArr(flcDiurnoSlots)>0) {
      const factorFlcD = factors.flc_d;
      rows.push(buildRow("Recargo Festivo Diurno (FLC)", flcDiurnoSlots, factorFlcD, true, "FESTIVO_COMPENSADO"));
    }
    
    // Recargo Festivo Compensado Nocturno (FLC) - 1.10 adicional
    if(!esNoCompensado && sumArr(flcNoctSlots)>0) {
      const factorFlcN = factors.flc_n;
      rows.push(buildRow("Recargo Festivo Nocturno (FLC)", flcNoctSlots, factorFlcN, true, "FESTIVO_COMPENSADO"));
    }
    
    // Recargo Festivo Sin Compensar Diurno (FLSC) - 1.80 adicional
    if(esNoCompensado && sumArr(flscDiurnoSlots)>0) {
      const factorFlscD = factors.flsc_d;
      rows.push(buildRow("Recargo Festivo Diurno (FLSC)", flscDiurnoSlots, factorFlscD, true, "FESTIVO_NO_COMPENSADO"));
    }
    
    // Recargo Festivo Sin Compensar Nocturno (FLSC) - 2.10 adicional
    if(esNoCompensado && sumArr(flscNoctSlots)>0) {
      const factorFlscN = factors.flsc_n;
      rows.push(buildRow("Recargo Festivo Nocturno (FLSC)", flscNoctSlots, factorFlscN, true, "FESTIVO_NO_COMPENSADO"));
    }
    
    // Extra en Festivo Diurno (+1.00 adicional al recargo festivo)
    if(sumArr(festExdSlots)>0) {
      const factorTotal = factors.fest_exd;
      rows.push(buildRow("Extra en Festivo Diurno", festExdSlots, factorTotal, true, tipoFestivo));
    }
    
    // Extra en Festivo Nocturno (+1.00 adicional al recargo festivo)
    if(sumArr(festExnSlots)>0) {
      const factorTotal = factors.fest_exn;
      rows.push(buildRow("Extra en Festivo Nocturno", festExnSlots, factorTotal, true, tipoFestivo));
    }
  }
  
  // AUXILIO DE TRANSPORTE (si corresponde)
  if(auxilioInfo.valor > 0 && sumArr(auxSlots) > 0) {
    rows.push(buildRow("Auxilio de Transporte", auxSlots, 0, esFestivo, tipoFestivo));
  }

  return rows;
}

// =========================
// NUEVO: Funci√≥n para procesar d√≠a festivo NO laborado
// =========================
function procesarDiaFestivoNoLaborado(params) {
  const {nombre, empresa, puesto, salario, valorHora, auxTrans, d, dia, observacion, 
         comisionPct, ss, prest, salarioMinimo, tipoFestivo, esFestivo} = params;
  
  const totalHoras = JORNADA_LEGAL_HORAS;
  const salarioDiario = valorHora * JORNADA_LEGAL_HORAS;
  const pagoBasicoInfo = calcularPagoBasico(totalHoras, valorHora, salarioDiario);
  
  const nSlots = SLOT_END - SLOT_START;
  const basicSlots = distribuirHorasEnFranjasLaborales(nSlots, totalHoras, 10, 19);
  
  const auxilioInfo = calcularAuxilioTransporte(
    parseFloat(salario || 0),
    parseFloat(salarioMinimo || 0),
    auxTrans * 30,
    0, // No trabaj√≥ horas
    true,
    null
  );
  
  const rows = [];
  
  // B√°sico completo
  rows.push({
    nombre, empresa, puesto,
    "Salario mensual": salario ? salario : "",
    "Valor Hora": valorHora,
    "Fecha": formatDateES(d),
    "D√≠a": dia,
    "Es Festivo": "S√≠ üéâ",
    "Tipo Festivo": tipoFestivo ? getEtiquetaFestivo(tipoFestivo) : "FLSC (No laborado)",
    "Concepto": "B√°sico Ordinario",
    "Observaci√≥n": observacion || "Festivo no laborado",
    "Tipo Observaci√≥n": "DIA_FESTIVO_NO_LABORADO",
    "Jornada Legal": JORNADA_LEGAL_HORAS + " horas",
    "Jornada Incompleta": "No",
    "Horario Distribuci√≥n": "10am-7pm",
    ...Object.fromEntries(slotLabels().map((lab, i) => [lab, round3(basicSlots[i] || 0)])),
    "Total Horas": round3(totalHoras),
    ...Object.fromEntries(slotLabels().map((lab, i) => ["vlr "+lab.replace("-","-"), 
      fmtMoney((basicSlots[i] / totalHoras) * pagoBasicoInfo.pagoTotal || 0)])),
    "Total por concepto": fmtMoney(pagoBasicoInfo.pagoTotal),
    "Valor diario de seguridad social": fmtMoney(0),
    "EPS": fmtMoney(pagoBasicoInfo.pagoTotal * ss.eps),
    "AFP": fmtMoney(pagoBasicoInfo.pagoTotal * ss.afp),
    "ARL": fmtMoney(pagoBasicoInfo.pagoTotal * ss.arl),
    "CAJA": fmtMoney(pagoBasicoInfo.pagoTotal * ss.caja),
    "Total Seguridad Social": fmtMoney(pagoBasicoInfo.pagoTotal * (ss.eps + ss.afp + ss.arl + ss.caja)),
    "CESANTIAS": fmtMoney(pagoBasicoInfo.pagoTotal * prest.ces),
    "PRIMAS": fmtMoney(pagoBasicoInfo.pagoTotal * prest.pri),
    "INTERES": fmtMoney(pagoBasicoInfo.pagoTotal * prest.inte),
    "VACACIONES": fmtMoney(pagoBasicoInfo.pagoTotal * prest.vac),
    "Total Prestaciones Sociales": fmtMoney(pagoBasicoInfo.pagoTotal * (prest.ces + prest.pri + prest.inte + prest.vac)),
    "Total": fmtMoney(pagoBasicoInfo.pagoTotal * (1 + (ss.eps + ss.afp + ss.arl + ss.caja) + (prest.ces + prest.pri + prest.inte + prest.vac))),
    "Valor Comisi√≥n": fmtMoney(0),
    "Valor Total": fmtMoney(pagoBasicoInfo.pagoTotal * (1 + (ss.eps + ss.afp + ss.arl + ss.caja) + (prest.ces + prest.pri + prest.inte + prest.vac))),
    "Observaciones": "Festivo no laborado - B√°sico completo distribuido 10am-7pm | " + auxilioInfo.mensaje
  });
  
  return rows;
}

// =========================
// Funci√≥n para procesar d√≠a especial
// =========================
function procesarDiaEspecial(params) {
  const {nombre, empresa, puesto, salario, valorHora, auxTrans, d, dia, observacion, rules, 
         comisionPct, ss, prest, salarioMinimo, esFestivo, tipoFestivo} = params;
  
  const totalHoras = rules.horasNormales;
  const salarioDiario = valorHora * JORNADA_LEGAL_HORAS;
  const pagoBasicoInfo = calcularPagoBasico(totalHoras, valorHora, salarioDiario);
  
  const nSlots = SLOT_END - SLOT_START;
  let basicSlots, auxSlots;
  
  if (rules.horarioEspecial) {
    basicSlots = distribuirHorasEnFranjasLaborales(nSlots, totalHoras, rules.inicioLaboral, rules.finLaboral);
    auxSlots = [...basicSlots];
  } else {
    const horasPorFranja = totalHoras / nSlots;
    basicSlots = Array(nSlots).fill(horasPorFranja);
    auxSlots = Array(nSlots).fill(horasPorFranja);
  }
  
  const auxilioInfo = calcularAuxilioTransporte(
    parseFloat(salario || 0),
    parseFloat(salarioMinimo || 0),
    auxTrans * 30,
    totalHoras,
    esFestivo,
    rules
  );
  
  const rows = [];
  
  if (rules.pagoBasico && totalHoras > 0) {
    rows.push(buildRowSpecial({
      nombre, empresa, puesto, salario, valorHora, auxTrans: auxilioInfo.valor, 
      d, dia, observacion, rules, comisionPct, ss, prest,
      concepto: "B√°sico",
      slotHours: basicSlots,
      incluirAuxilio: false,
      esBasico: true,
      esFestivo: false,
      pagoBasicoCalculado: pagoBasicoInfo,
      auxilioInfo: auxilioInfo,
      horarioEspecial: rules.horarioEspecial ? "10am-7pm" : "general",
      tipoFestivoEspecial: tipoFestivo
    }));
  }
  
  if (rules.pagoAuxilio && auxilioInfo.valor > 0) {
    rows.push(buildRowSpecial({
      nombre, empresa, puesto, salario, valorHora, auxTrans: auxilioInfo.valor, 
      d, dia, observacion, rules, comisionPct, ss, prest,
      concepto: "Auxilio de Transporte",
      slotHours: auxSlots,
      incluirAuxilio: true,
      esBasico: false,
      esFestivo: false,
      pagoBasicoCalculado: pagoBasicoInfo,
      auxilioInfo: auxilioInfo,
      horarioEspecial: rules.horarioEspecial ? "10am-7pm" : "general",
      tipoFestivoEspecial: tipoFestivo
    }));
  }
  
  return rows;
}

function sumArr(a){ return a.reduce((x,y)=>x+y,0); }
function round3(n){ return Math.round(n*1000)/1000; }
function fmtMoney(n){ return Math.round(n); }
function formatDateES(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}

// =========================
// Parsear tabla pegada
// =========================
function parsePastedTable(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out=[];
  for(const line of lines){
    const cols = line.split(/\t| {2,}|;/).map(x=>x.trim());
    if(cols.length<1) continue;
    
    if(/fecha/i.test(cols[0]) && /entrada/i.test(cols[1])) continue;

    const d = parseDateFlexible(cols[0]);
    if(!d) continue;
    
    out.push({
      date: d,
      entry: cols[1]||"",
      inter1: cols[2]||"",
      inter2: cols[3]||"",
      exit: cols[4]||"",
      observacion: cols[5]||""
    });
  }
  return out;
}

// =========================
// Exportar a CSV
// =========================
function exportToCSV(rows, filename) {
  if (!rows.length) return;
  
  const headers = Object.keys(rows[0]);
  const csvContent = [
    headers.join(','),
    ...rows.map(row => 
      headers.map(header => {
        const value = row[header];
        if (value === null || value === undefined) return '';
        const stringValue = String(value);
        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
          return '"' + stringValue.replace(/"/g, '""') + '"';
        }
        return stringValue;
      }).join(',')
    )
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// =========================
// Exportar a Excel
// =========================
function exportToExcel(rows, filename) {
  if (!checkXLSXLoaded()) {
    alert('La librer√≠a de Excel no est√° disponible. Exportando como CSV en su lugar.');
    exportToCSV(rows, filename.replace('.xlsx', '.csv'));
    return;
  }
  
  try {
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "nomina");
    XLSX.writeFile(wb, filename);
  } catch (error) {
    console.error('Error al exportar Excel:', error);
    alert('Error al exportar Excel: ' + error.message + '\nExportando como CSV...');
    exportToCSV(rows, filename.replace('.xlsx', '.csv'));
  }
}

// =========================
// Render tabla preview
// =========================
let OUTPUT_ROWS = [];

function renderPreview(rows){
  const head = document.getElementById("headRow");
  const body = document.getElementById("bodyRows");
  head.innerHTML = "";
  body.innerHTML = "";

  if(!rows.length){
    head.innerHTML = "<th>Sin datos</th>";
    return;
  }
  const cols = Object.keys(rows[0]);
  cols.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c;
    head.appendChild(th);
  });

  rows.slice(0,25).forEach(r=>{
    const tr = document.createElement("tr");
    cols.forEach(c=>{
      const td = document.createElement("td");
      td.textContent = r[c];
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

// =========================
// Acciones principales
// =========================
document.getElementById("btnCalc").onclick = ()=>{
  const nombre = document.getElementById("nombre").value.trim();
  const empresa = document.getElementById("empresa").value.trim();
  const puesto = document.getElementById("puesto").value.trim();
  const salario = document.getElementById("salario").value.trim();
  const valorHora = parseFloat(document.getElementById("valorHora").value||0);
  const auxTrans = parseFloat(document.getElementById("auxTrans").value||0);
  const jornada = parseFloat(document.getElementById("jornada").value||8);
  const iniNoct = document.getElementById("iniNoct").value.trim() || "21:00";
  const finNoct = document.getElementById("finNoct").value.trim() || "06:00";
  const salarioMinimo = document.getElementById("salarioMinimo").value.trim();
  
  if (jornada > JORNADA_LEGAL_HORAS) {
    console.warn("‚ö†Ô∏è Nota: La jornada pactada (" + jornada + "h) supera la jornada legal m√°xima de " + JORNADA_LEGAL_HORAS + " horas.");
  }

  const factors = {
    noct: parseFloat(document.getElementById("f_noct").value||0.35),
    exd:  parseFloat(document.getElementById("f_exd").value||0.25),
    exn:  parseFloat(document.getElementById("f_exn").value||0.75),
    flc_d: parseFloat(document.getElementById("f_flc_d").value||0.80),
    flc_n: parseFloat(document.getElementById("f_flc_n").value||1.10),
    flsc_d: parseFloat(document.getElementById("f_flsc_d").value||1.80),
    flsc_n: parseFloat(document.getElementById("f_flsc_n").value||2.10),
    fest_exd: parseFloat(document.getElementById("f_fest_exd").value||1.00),
    fest_exn: parseFloat(document.getElementById("f_fest_exn").value||1.00)
  };

  const comisionPct = parseFloat(document.getElementById("comision").value||0)/100;

  const ss = {
    enabled: document.getElementById("chkSS").checked,
    eps: parseFloat(document.getElementById("p_eps").value||0),
    afp: parseFloat(document.getElementById("p_afp").value||0),
    arl: parseFloat(document.getElementById("p_arl").value||0),
    caja: parseFloat(document.getElementById("p_caja").value||0),
  };

  const prest = {
    enabled: document.getElementById("chkPrest").checked,
    ces: parseFloat(document.getElementById("p_ces").value||0),
    pri: parseFloat(document.getElementById("p_pri").value||0),
    inte: parseFloat(document.getElementById("p_int").value||0),
    vac: parseFloat(document.getElementById("p_vac").value||0),
  };

  const days = parsePastedTable(document.getElementById("tabla").value);
  const allRows = [];
  
  let festivosDetectados = 0;
  let compensatoriosDetectados = 0;
  let flcDetectados = 0;
  let flscDetectados = 0;
  
  for(const day of days) {
    if (esFestivoColombia(day.date)) {
      festivosDetectados++;
    }
    if (day.observacion && day.observacion.toUpperCase().includes("COMPENSATORIO")) {
      compensatoriosDetectados++;
    }
    if (day.observacion && day.observacion.toUpperCase().includes("FLC")) {
      flcDetectados++;
    }
    if (day.observacion && day.observacion.toUpperCase().includes("FLSC")) {
      flscDetectados++;
    }
  }
  
  console.log("üìä RESUMEN DETECTADO:");
  console.log("üéâ Festivos autom√°ticos: " + festivosDetectados + " d√≠as");
  console.log("üìÖ Compensatorios: " + compensatoriosDetectados + " d√≠as");
  console.log("‚úÖ FLC detectados: " + flcDetectados + " d√≠as (0.80 adicional)");
  console.log("‚ö†Ô∏è FLSC detectados: " + flscDetectados + " d√≠as (1.80 adicional)");
  
  if (flcDetectados === 0 && flscDetectados === 0 && festivosDetectados > 0) {
    console.warn("üí° CONSEJO: Para festivos detectados autom√°ticamente, agregar 'FLC' o 'FLSC' en Observaciones.");
    console.warn("   Ejemplo: 'DOMINGO FLSC' o 'FESTIVO FLC'");
  }

  for(const day of days){
    const rows = calcDayRows({
      nombre,empresa,puesto,salario,valorHora,auxTrans,jornada,iniNoct,finNoct,
      factors,ss,prest,comisionPct,salarioMinimo
    }, day);
    allRows.push(...rows);
  }

  allRows.sort((a,b)=>{
    const da = a["Fecha"].split("/").reverse().join("-");
    const db = b["Fecha"].split("/").reverse().join("-");
    if(da<db) return -1;
    if(da>db) return 1;
    const ordenConcepto = {
      "B√°sico Ordinario": 1,
      "Auxilio de Transporte": 2,
      "Recargo Nocturno Ordinario": 3,
      "Hora Extra Diurna Ordinaria": 4,
      "Hora Extra Nocturna Ordinaria": 5,
      "Recargo Festivo Diurno (FLC)": 6,
      "Recargo Festivo Nocturno (FLC)": 7,
      "Recargo Festivo Diurno (FLSC)": 8,
      "Recargo Festivo Nocturno (FLSC)": 9,
      "Extra en Festivo Diurno": 10,
      "Extra en Festivo Nocturno": 11
    };
    const ordenA = ordenConcepto[a["Concepto"]] || 99;
    const ordenB = ordenConcepto[b["Concepto"]] || 99;
    return ordenA - ordenB;
  });

  OUTPUT_ROWS = allRows;
  renderPreview(allRows);
};

document.getElementById("btnClear").onclick = ()=>{
  OUTPUT_ROWS = [];
  renderPreview([]);
};

document.getElementById("btnXlsx").onclick = ()=>{
  if(!OUTPUT_ROWS.length){
    alert("Primero calcula para generar el archivo.");
    return;
  }
  exportToExcel(OUTPUT_ROWS, "nomina_por_horas_festivos.xlsx");
};

document.getElementById("btnCSV").onclick = ()=>{
  if(!OUTPUT_ROWS.length){
    alert("Primero calcula para generar el archivo.");
    return;
  }
  exportToCSV(OUTPUT_ROWS, "nomina_por_horas_festivos.csv");
};

// Inicializaci√≥n
renderPreview([]);

console.log("‚úÖ SISTEMA DE FESTIVOS MEJORADO:");
console.log("   - FLC (Festivo Laborado Compensado): 0.80 adicional - Se da d√≠a libre");
console.log("   - FLSC (Festivo Laborado Sin Compensar): 1.80 adicional - No se da d√≠a libre");
console.log("   - Festivos autom√°ticos = FLSC por defecto (1.80)");
console.log("   - Especificar en Observaciones: 'FLC' o 'FLSC'");
console.log("   - Ejemplo: 'DOMINGO FLSC' o 'FESTIVO FLC'");
</script>
</body>
</html>
